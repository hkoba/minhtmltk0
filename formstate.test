#!/bin/sh
# -*- mode: tcl; coding: utf-8 -*-
# the next line restarts using tclsh \
    exec tclsh -encoding utf-8 "$0" ${1+"$@"}
    
package require tcltest
namespace import tcltest::test

package require struct::list

set P formstate
set type ::minhtmltk::formstate

test $P-init load -body {
    source [file rootname [info script]].tcl
} -result $type

proc iota1 {n} {
    struct::list mapfor v [struct::list iota $n] {expr {$v+1}}
}

#========================================
set t_names {}
set t_pairs {}
set i 0

test $P-create "" -body {
    set form [$type %AUTO%]
    list [$form cget -name] [$form cget -action] [$form cget -node] \
	[$form names] [$form get]
} -result [list "" "" "" "" ""]


set value dval[incr d]
test $P-item-text-[incr i] "" -body {
    
    set name dummy$d
    set item [$form item register node single  \
		  node-$name [list name $name editable yes]]
    
    set rc0 [catch {$item get}]
    set rc [$item get outval]
    list $rc0 $rc [info exists outval]
} -result [list 1 0 0]

lappend t_names $name
#----------------------------------------


test $P-item-text-[incr i] "" -body {
    $item set foo
    $item get
} -result foo


test $P-item-text-[incr i] "" -body {
    $item set bar
    set rc [$item get outval]
    list $rc $outval
} -result [list 1 bar]

lappend t_pairs $name bar
#----------------------------------------

incr d
test $P-item-radio-[incr i] "" -body {
    
    set name dummy$d
    
    set result {}
    for {set i 1} {$i <= 3} {incr i} {
	set item [$form item register node single  \
		      node-$name [list name $name value $i]]
    }
    
    $item get outval
} -result 0

lappend t_names $name
#----------------------------------------

test $P-item-radio-[incr i] "" -body {
    
    set result {}
    for {set i 1} {$i <= 3} {incr i} {
	$item set $i
	lappend result [list [$item get v] $v]
    }
    set result
} -result {{1 1} {1 2} {1 3}}

lappend t_pairs $name 3
#----------------------------------------

incr d
test $P-item-checkbox-[incr i] "" -body {
    
    set name dummy$d
    
    set result {}
    for {set i 1} {$i <= 3} {incr i} {
	set item [$form item register node multi  \
		      node-$name [list name $name value $i]]
    }
    
    $item get outval
} -result 0

lappend t_names $name
#----------------------------------------

test $P-item-checkbox-[incr i] "" -body {
    
    set result {}
    for {set i 1} {$i <= 3} {incr i} {
	$item set {*}[iota1 $i]
	lappend result [$item get]
    }
    set result
} -result {1 {1 2} {1 2 3}}

lappend t_pairs $name {1 2 3}
#----------------------------------------

test $P-item-checkbox-[incr i] "" -body {
    $form get
} -result $t_pairs

